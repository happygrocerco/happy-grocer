<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Happy Grocer - Smart Shopping Made Easy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f7f3a9;min-height:100vh;color:#6b46c1}
    .container{max-width:400px;margin:0 auto;padding:20px;min-height:100vh}
    .header{text-align:center;margin-bottom:30px;color:#6b46c1}
    .logo{font-size:4rem;margin-bottom:15px;background:#16a34a;border-radius:20px;width:120px;height:120px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .cart-logo{width:80px;height:80px;position:relative}
    .cart-body{width:50px;height:35px;background:#fbbf24;border:4px solid #4c1d95;border-radius:8px;position:absolute;top:25px;left:20px}
    .cart-handle{width:20px;height:25px;border:4px solid #fbbf24;border-right:none;border-radius:8px 0 0 8px;position:absolute;top:25px;left:0}
    .cart-wheel1,.cart-wheel2{width:8px;height:8px;background:#fbbf24;border:2px solid #4c1d95;border-radius:50%;position:absolute;bottom:8px}
    .cart-wheel1{left:25px}.cart-wheel2{right:25px}
    .smiley-face{position:absolute;top:5px;left:25px;width:30px;height:30px;background:#fbbf24;border:3px solid #4c1d95;border-radius:50%}
    .smiley-eyes{position:absolute;top:8px;left:8px}
    .smiley-eyes::before,.smiley-eyes::after{content:'';width:4px;height:6px;background:#4c1d95;border-radius:50%;position:absolute}
    .smiley-eyes::before{left:0}.smiley-eyes::after{right:0;left:10px}
    .smiley-mouth{position:absolute;bottom:6px;left:6px;width:16px;height:8px;border:2px solid #4c1d95;border-top:none;border-radius:0 0 16px 16px}
    .app-title{font-size:2.8rem;font-weight:800;margin-bottom:5px;letter-spacing:1px;color:#6b46c1;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .subtitle{font-size:1.1rem;opacity:.9;font-weight:500;color:#16a34a}

    .card{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:25px;padding:30px;margin-bottom:25px;box-shadow:0 20px 40px rgba(139,92,246,.3),0 10px 20px rgba(251,191,36,.2),inset 0 1px 0 rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.3);transition:all .4s cubic-bezier(.4,0,.2,1)}
    .card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 30px 60px rgba(139,92,246,.4),0 15px 30px rgba(251,191,36,.3),inset 0 1px 0 rgba(255,255,255,.8)}

    .step-indicator{display:flex;justify-content:center;margin-bottom:25px;gap:10px}
    .step{width:12px;height:12px;border-radius:50%;background:#e0e0e0;transition:all .3s ease}
    .step.active{background:linear-gradient(135deg,#8b5cf6,#fde047);transform:scale(1.4);box-shadow:0 4px 15px rgba(139,92,246,.6)}
    .step.completed{background:linear-gradient(135deg,#10b981,#fbbf24);transform:scale(1.2)}
    .screen{display:none}.screen.active{display:block}
    h2{color:#6b46c1;margin-bottom:25px;font-size:2rem;text-align:center;font-weight:700}

    .emoji-header{font-size:4rem;text-align:center;margin-bottom:20px;filter:drop-shadow(3px 3px 6px rgba(0,0,0,.3));animation:bounce 2s ease-in-out infinite}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}

    .option-group{margin-bottom:25px}
    .checkbox-group{display:grid;gap:12px}
    .checkbox-item{display:flex;align-items:center;padding:20px;border:2px solid #6b46c1;border-radius:18px;cursor:pointer;transition:all .3s ease;background:rgba(255,255,255,.95);position:relative;overflow:hidden}
    .checkbox-item:hover{border-color:#16a34a;background:#fff;transform:translateY(-3px);box-shadow:0 10px 25px rgba(107,70,193,.3)}
    .checkbox-item.selected{border-color:#6b46c1;background:#16a34a;color:#fff;transform:translateY(-5px) scale(1.02);box-shadow:0 15px 35px rgba(124,58,237,.4)}
    .checkbox-item input{margin-right:12px;transform:scale(1.2)}
    .option-emoji{font-size:2rem;margin-right:15px;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.3));animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

    .input-group{margin-bottom:20px}
    .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#555}
    input[type="number"],select{width:100%;padding:18px 20px;border:2px solid rgba(251,191,36,.3);border-radius:15px;font-size:1.1rem;background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(251,191,36,.1));backdrop-filter:blur(10px);transition:all .3s ease;font-family:'Inter',sans-serif;font-weight:500}
    input:focus,select:focus{outline:none;border-color:#fbbf24;background:rgba(255,255,255,.95);box-shadow:0 0 0 3px rgba(251,191,36,.3),0 8px 25px rgba(124,58,237,.2);transform:translateY(-2px)}

    .btn{width:100%;padding:16px;border:none;border-radius:18px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);margin-top:16px;background:#16a34a;color:#fff;text-transform:uppercase;letter-spacing:.6px;box-shadow:0 8px 22px rgba(124,58,237,.35)}
    .btn:hover{transform:translateY(-2px);background:#6b46c1;box-shadow:0 14px 32px rgba(124,58,237,.45)}
    .btn:active{transform:translateY(-1px) scale(.99)}
    .btn.secondary{background:#fff;color:#6b46c1;border:2px solid #6b46c1;box-shadow:none;text-transform:none}
    .btn.secondary:hover{background:#6b46c1;color:#fff}

    .progress-text{text-align:center;color:#6b46c1;margin-bottom:20px;font-weight:600}

    .loading{text-align:center;padding:40px}
    .spinner{width:60px;height:60px;border:5px solid rgba(253,224,71,.3);border-top:5px solid #8b5cf6;border-right:5px solid #fde047;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px;filter:drop-shadow(0 4px 8px rgba(139,92,246,.3))}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .list-item{background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(253,224,71,.1));backdrop-filter:blur(15px);border-radius:18px;padding:25px;margin-bottom:20px;border-left:5px solid #8b5cf6;border:1px solid rgba(139,92,246,.2);box-shadow:0 8px 25px rgba(139,92,246,.2);transition:all .3s ease}
    .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .item-title{font-weight:bold;color:#333;font-size:1.2rem}
    .quantity-badge{background:#16a34a;color:#fff;padding:6px 16px;border-radius:25px;font-size:.9rem;font-weight:600;box-shadow:0 4px 12px rgba(124,58,237,.3)}
    .product-block{margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,.06)}
    .product-block:last-child{border-bottom:none}
    .product-name{font-weight:600;color:#444;margin-bottom:6px;font-size:1.05rem}
    .product-details{color:#666;line-height:1.6}
    .price{font-weight:700;color:#16a34a;font-size:1.05rem}

    .summary-card{background:#16a34a;color:#fff;border-radius:20px;padding:30px;margin-top:25px;box-shadow:0 20px 40px rgba(124,58,237,.4);border:1px solid rgba(255,255,255,.2)}
    .summary-row{display:flex;justify-content:space-between;margin-bottom:12px;align-items:center}
    .summary-row:last-child{margin-bottom:0;padding-top:15px;border-top:1px solid rgba(255,255,255,.3);font-weight:bold;font-size:1.2rem}

    .util-row{display:flex;gap:12px;margin-top:12px}
    .util{flex:1;background:#fff;color:#6b46c1;border:2px solid #6b46c1}
    .util:hover{background:#6b46c1;color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="cart-logo">
          <div class="cart-handle"></div><div class="cart-body"></div><div class="cart-wheel1"></div><div class="cart-wheel2"></div>
          <div class="smiley-face"><div class="smiley-eyes"></div><div class="smiley-mouth"></div></div>
        </div>
      </div>
      <h1 class="app-title">Happy Grocer</h1>
      <p class="subtitle">Shopping Smart for Happy Carts</p>
    </div>

    <div class="step-indicator">
      <div class="step active" id="step1"></div>
      <div class="step" id="step2"></div>
      <div class="step" id="step3"></div>
      <div class="step" id="step4"></div>
      <!-- step5 kept for future store screen; currently hidden -->
    </div>
    <div class="progress-text" id="progressText">Step 1 of 4</div>

    <!-- Screen 1: Priorities -->
    <div class="screen active" id="screen1">
      <div class="card">
        <div class="emoji-header"><span style="color:#8b5cf6;">üéØ</span></div>
        <h2>What's Your Shopping Goal?</h2>
        <p style="text-align:center;margin-bottom:25px;color:#666;">Choose your priorities (you can select multiple)</p>
        <div class="option-group">
          <div class="checkbox-group">
            <div class="checkbox-item" onclick="selectOption(this,'budget')">
              <input type="checkbox" id="budget"><span class="option-emoji">üí∞</span><span>Budget-friendly</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'health')">
              <input type="checkbox" id="health"><span class="option-emoji">ü•ó</span><span>Health-focused</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'calories')">
              <input type="checkbox" id="calories"><span class="option-emoji">üî•</span><span>Low-calorie</span>
            </div>
          </div>
        </div>
        <button class="btn" onclick="goToScreen(2)">Continue</button>
      </div>
    </div>

    <!-- Screen 2: Dietary -->
    <div class="screen" id="screen2">
      <div class="card">
        <div class="emoji-header"><span style="color:#fbbf24;">ü•ó</span></div>
        <h2>Dietary Preferences</h2>
        <p style="text-align:center;margin-bottom:25px;color:#666;">Select any dietary restrictions</p>
        <div class="option-group">
          <div class="checkbox-group">
            <div class="checkbox-item" onclick="selectOption(this,'vegetarian')">
              <input type="checkbox" id="vegetarian"><span class="option-emoji">üå±</span><span>Vegetarian</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'vegan')">
              <input type="checkbox" id="vegan"><span class="option-emoji">üåø</span><span>Vegan</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'keto')">
              <input type="checkbox" id="keto"><span class="option-emoji">ü•ì</span><span>Keto</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'gluten_free')">
              <input type="checkbox" id="gluten_free"><span class="option-emoji">üåæ</span><span>Gluten-Free</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'high_protein')">
              <input type="checkbox" id="high_protein"><span class="option-emoji">üí™</span><span>High Protein</span>
            </div>
          </div>
        </div>
        <div class="util-row">
          <button class="btn secondary" onclick="goBack()">Back</button>
          <button class="btn" onclick="goToScreen(3)">Continue</button>
        </div>
      </div>
    </div>

    <!-- Screen 3: Categories -->
    <div class="screen" id="screen3">
      <div class="card">
        <div class="emoji-header"><span style="color:#8b5cf6;">üçΩÔ∏è</span></div>
        <h2>What Do You Need?</h2>
        <p style="text-align:center;margin-bottom:25px;color:#666;">Select food categories</p>
        <div class="option-group">
          <div class="checkbox-group">
            <div class="checkbox-item" onclick="selectOption(this,'proteins')">
              <input type="checkbox" id="proteins"><span class="option-emoji">üçó</span><span>Proteins</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'dairy')">
              <input type="checkbox" id="dairy"><span class="option-emoji">ü•õ</span><span>Dairy</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'grains')">
              <input type="checkbox" id="grains"><span class="option-emoji">üçû</span><span>Grains</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'fruits')">
              <input type="checkbox" id="fruits"><span class="option-emoji">üçé</span><span>Fruits</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'vegetables')">
              <input type="checkbox" id="vegetables"><span class="option-emoji">ü•¨</span><span>Vegetables</span>
            </div>
            <div class="checkbox-item" onclick="selectOption(this,'snacks')">
              <input type="checkbox" id="snacks"><span class="option-emoji">ü•ú</span><span>Snacks</span>
            </div>
          </div>
        </div>
        <div class="util-row">
          <button class="btn secondary" onclick="goBack()">Back</button>
          <button class="btn" onclick="validateAndGoToScreen(4)">Continue</button>
        </div>
      </div>
    </div>

    <!-- Screen 4: Household (ZIP hidden on purpose) -->
    <div class="screen" id="screen4">
      <div class="card">
        <div class="emoji-header"><span style="color:#fbbf24;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span></div>
        <h2>Household Details</h2>
        <div class="input-group">
          <label>üë• How many people?</label>
          <input type="number" id="householdSize" value="2" min="1">
        </div>
        <div class="input-group">
          <label>üìÖ How many weeks?</label>
          <select id="duration">
            <option value="1">1 week</option>
            <option value="2">2 weeks</option>
          </select>
        </div>
        <!-- ZIP UI intentionally hidden for MVP; keep element in DOM for future -->
        <div class="input-group" style="display:none;">
          <label>üìç Zip code</label>
          <input type="number" id="zipcode" placeholder="12345">
        </div>
        <div class="util-row">
          <button class="btn secondary" onclick="goBack()">Back</button>
          <button class="btn" onclick="generateList()">Generate My List</button>
        </div>
      </div>
    </div>

    <!-- (Future) Screen 5: Store selection (fully hidden for MVP)
    <div class="screen" id="screen5">
      ... keep your store UI here if you want to re-enable later ...
    </div>
    -->

    <!-- Loading -->
    <div class="screen" id="loadingScreen">
      <div class="card">
        <div class="loading">
          <div class="spinner"></div>
          <h2>Creating Your Smart Shopping List</h2>
          <p>Finding the best items...</p><p>Optimizing for your choices...</p>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="screen" id="resultsScreen">
      <div class="card">
        <div class="emoji-header"><span style="color:#fbbf24;">‚ú®</span></div>
        <h2>Your Smart Shopping List</h2>
        <div id="shoppingList"></div>
        <div class="summary-card" id="summary"></div>
        <div class="util-row">
          <button class="btn util" onclick="copyList()">Copy List</button>
          <button class="btn util" onclick="emailList()">Email Me This</button>
        </div>
        <div class="util-row">
          <button class="btn" onclick="printList()" style="flex:1;background:#16a34a;">Print List</button>
          <button class="btn" onclick="saveList()" style="flex:1;background:#16a34a;">Save List</button>
        </div>
        <button class="btn" onclick="startOver()" style="margin-top:16px;">Create Another List</button>
      </div>
    </div>
  </div>

  <script>
    // === PLACEHOLDERS for future integration ===
    const KROGER_CLIENT_ID = "YOUR_KROGER_CLIENT_ID_HERE";
    const KROGER_CLIENT_SECRET = "YOUR_KROGER_CLIENT_SECRET_HERE";
    const KROGER_API_ENDPOINT = "https://api.kroger.com/v1/products";
    
    // ------------- State & Navigation -------------
    let currentScreen = 1;
    let generatedText = '';

    function selectOption(el){ const cb=el.querySelector('input'); cb.checked=!cb.checked; el.classList.toggle('selected',cb.checked); }
    function updateSteps(step){
      for(let i=1;i<=4;i++){ const s=document.getElementById('step'+i); if(!s) continue;
        s.className = i<step ? 'step completed' : (i===step?'step active':'step'); }
      document.getElementById('progressText').textContent='Step '+step+' of 4';
    }
    function goToScreen(n){
      document.getElementById('screen'+currentScreen).classList.remove('active');
      document.getElementById('screen'+n).classList.add('active');
      currentScreen=n; updateSteps(n);
    }
    function goBack(){ if(currentScreen>1) goToScreen(currentScreen-1); }
    function validateAndGoToScreen(n){
      const any=[...document.querySelectorAll('#screen3 input[type="checkbox"]')].some(c=>c.checked);
      if(!any){ alert('Please select at least one food category!'); return; }
      goToScreen(n);
    }

    // ------------- Catalog with tags & meta -------------
    // tags: vegan, vegetarian, meat, fish, dairy, gluten, grain, veg, fruit, snack, protein, high-carb, low-cal, heart-healthy
    const CATALOG = [
      // proteins
      {name:'Chicken breast', note:'2 lbs', price:12, tags:['protein','meat','low-cal']},
      {name:'Ground turkey', note:'2 lbs', price:10, tags:['protein','meat','low-cal']},
      {name:'Salmon fillets', note:'1 lb', price:9, tags:['protein','fish','heart-healthy','low-cal']},
      {name:'Eggs', note:'1 dozen', price:3, tags:['protein','vegetarian','dairy']},
      {name:'Greek yogurt', note:'32 oz', price:5, tags:['protein','vegetarian','dairy']},
      {name:'Tofu', note:'2 blocks', price:6, tags:['protein','vegan','vegetarian','low-cal']},
      {name:'Tempeh', note:'1 pack', price:4, tags:['protein','vegan','vegetarian']},
      {name:'Lentils', note:'2 lbs', price:4, tags:['protein','vegan','vegetarian','high-carb']},
      {name:'Chickpeas', note:'2 cans', price:3, tags:['protein','vegan','vegetarian','high-carb']},
      {name:'Edamame', note:'12 oz', price:4, tags:['protein','vegan','vegetarian','low-cal']},

      // dairy
      {name:'Cottage cheese', note:'16 oz', price:4, tags:['dairy','vegetarian','protein','low-cal']},
      {name:'Milk', note:'64 fl oz', price:3.5, tags:['dairy','vegetarian']},

      // grains
      {name:'Whole-wheat pasta', note:'1 lb', price:3, tags:['grain','gluten','high-carb']},
      {name:"Dave's Killer Bread", note:'27 oz', price:5, tags:['grain','gluten','high-carb']},
      {name:'Brown rice', note:'2 lbs', price:4, tags:['grain','high-carb']},
      {name:'Quinoa', note:'1 lb', price:5, tags:['grain','high-carb','gluten-free']},
      {name:'Cauliflower rice', note:'2 frozen bags', price:6, tags:['veg','vegan','vegetarian','low-cal']},

      // fruits & veg
      {name:'Bananas', note:'6', price:2, tags:['fruit','vegan','vegetarian','high-carb']},
      {name:'Apples', note:'4', price:3, tags:['fruit','vegan','vegetarian','low-cal']},
      {name:'Spinach', note:'1 bag', price:3, tags:['veg','vegan','vegetarian','low-cal','heart-healthy']},
      {name:'Broccoli', note:'2 heads', price:3, tags:['veg','vegan','vegetarian','low-cal','heart-healthy']},
      {name:'Zucchini', note:'4', price:4, tags:['veg','vegan','vegetarian','low-cal']},
      {name:'Avocado', note:'2', price:3, tags:['veg','vegan','vegetarian','heart-healthy']},

      // snacks
      {name:'Almonds', note:'12 oz', price:6, tags:['snack','vegan','vegetarian','protein','heart-healthy']},
      {name:'String cheese', note:'10 sticks', price:5, tags:['snack','dairy','vegetarian','protein','low-cal']},
      {name:'Hummus', note:'10 oz', price:4, tags:['snack','vegan','vegetarian']},
      {name:'Popcorn kernels', note:'1 lb', price:3, tags:['snack','vegan','vegetarian','grain','high-carb']},
      {name:'Dark chocolate (70%)', note:'3.5 oz', price:3, tags:['snack','vegan','vegetarian']}
    ];

    // ------------- Diet & priority logic -------------
    function flags(){
      return {
        vegan: document.getElementById('vegan').checked,
        vegetarian: document.getElementById('vegetarian').checked,
        keto: document.getElementById('keto').checked,
        gluten_free: document.getElementById('gluten_free').checked,
        high_protein: document.getElementById('high_protein').checked,
        budget: document.getElementById('budget').checked,
        health: document.getElementById('health').checked,
        low_cal: document.getElementById('calories').checked
      };
    }

    function allowedByDiet(item, f){
      const t=item.tags||[];
      if(f.vegan && (t.includes('meat')||t.includes('fish')||t.includes('dairy'))) return false;
      if(f.vegetarian && (t.includes('meat')||t.includes('fish'))) return false;
      if(f.keto && t.includes('high-carb')) return false;
      if(f.gluten_free && t.includes('gluten')) return false;
      return true;
    }

    // Score items by priorities; higher = better
    function scoreItem(item, f){
      let s = 0;

      // Budget: prefer cheaper
      if(f.budget) s += Math.max(0, 12 - (item.price||0)); // cheaper -> higher

      // Low-calorie: prefer 'low-cal' tag; lightly penalize high-carb unless it's fruit/whole-grain
      if(f.low_cal){
        if((item.tags||[]).includes('low-cal')) s += 6;
        if((item.tags||[]).includes('high-carb')) s -= 2;
      }

      // Health-focused: boost veg/fruit/protein/heart-healthy; small penalty to purely snacky sweets
      if(f.health){
        if((item.tags||[]).includes('veg') || (item.tags||[]).includes('fruit')) s += 5;
        if((item.tags||[]).includes('protein')) s += 3;
        if((item.tags||[]).includes('heart-healthy')) s += 2;
        if(item.name.toLowerCase().includes('chocolate')) s -= 2;
      }

      // High-protein preference
      if(f.high_protein && (item.tags||[]).includes('protein')) s += 3;

      // Small baseline to avoid negative-only scores
      s += 1;

      return s;
    }

    function pickPerCategory(f){
      // How many per category if selected
      const target = {
        proteins: 3,
        dairy: 1,
        grains: 1,
        fruits: 2,
        vegetables: 2,
        snacks: 2
      };
      // Which categories the user chose
      const chosen = {
        proteins: document.getElementById('proteins').checked,
        dairy: document.getElementById('dairy').checked,
        grains: document.getElementById('grains').checked,
        fruits: document.getElementById('fruits').checked,
        vegetables: document.getElementById('vegetables').checked,
        snacks: document.getElementById('snacks').checked
      };

      // If user didn‚Äôt pick any category, default to a balanced basket
      if(!Object.values(chosen).some(Boolean)){
        chosen.proteins = chosen.grains = chosen.vegetables = true;
      }

      const tagMap = {proteins:'protein', dairy:'dairy', grains:'grain', fruits:'fruit', vegetables:'veg', snacks:'snack'};
      let out = [];

      for(const [cat, want] of Object.entries(chosen)){
        if(!want) continue;
        const tag = tagMap[cat];
        // Candidate pool filtered by diet
        const pool = CATALOG.filter(x => (x.tags||[]).includes(tag) && allowedByDiet(x,f));
        // Sort by score desc
        pool.sort((a,b)=>scoreItem(b,f)-scoreItem(a,f));
        // Take top N
        out.push(...pool.slice(0, target[cat]));
      }

      // De-dupe by name
      const seen=new Set(); out = out.filter(i=>!seen.has(i.name) && seen.add(i.name));
      return out;
    }

   // ------------- Generate & render -------------
function generateList(){
  // Hide current screen
  const active = document.querySelector('.screen.active');
  if (active) active.classList.remove('active');

  // Show loading, then results
  const loading = document.getElementById('loadingScreen');
  if (loading) loading.classList.add('active');

  setTimeout(() => {
    if (loading) loading.classList.remove('active');
    document.getElementById('resultsScreen').classList.add('active');
    showResultsSafe(); // call the safe wrapper
  }, 900);
}
    
  function showResultsSafe(){
  try {
    // Your existing renderer
    showResults();
  } catch (e) {
    console.error(e);
    // Minimal fallback render so the page still works
    const listEl = document.getElementById('shoppingList');
    const sumEl  = document.getElementById('summary');

    if (listEl) {
      listEl.innerHTML = `
        <div class="list-item">
          <div class="item-header">
            <span class="item-title">Quick List (Fallback)</span>
            <span class="quantity-badge">Items: 3</span>
          </div>
          <div class="product-block">
            <div class="product-name">Apples</div>
            <div class="product-details"><div>4</div><div class="price">$3.00</div></div>
          </div>
          <div class="product-block">
            <div class="product-name">Rice</div>
            <div class="product-details"><div>2 lb</div><div class="price">$5.00</div></div>
          </div>
          <div class="product-block">
            <div class="product-name">Beans</div>
            <div class="product-details"><div>2 cans</div><div class="price">$4.00</div></div>
          </div>
        </div>`;
    }

    if (sumEl) {
      sumEl.innerHTML = `
        <h3 style="margin-bottom:20px;text-align:center;">Shopping Summary</h3>
        <div class="summary-row"><span>Diet Plan:</span><span>Your Plan</span></div>
        <div class="summary-row"><span>Total Items:</span><span>3</span></div>
        <div class="summary-row"><span>Estimated Total:</span><span>$12.00</span></div>`;
    }

    alert('Something inside showResults() crashed: ' + e.message);
  }
}
  
    function showResults(){
      document.getElementById('loadingScreen').classList.remove('active');
      document.getElementById('resultsScreen').classList.add('active');

      const f = flags();
      // Build items strictly from chosen categories + priorities, filtered by diet
      let items = pickPerCategory(f);

      // If still empty (edge case), fall back to a safe set
      if(items.length === 0){
        items = CATALOG.filter(x => allowedByDiet(x,f) && ((x.tags||[]).includes('veg') || (x.tags||[]).includes('protein'))).slice(0,5);
      }

      // Compute total
      let total = items.reduce((acc,i)=>acc+(i.price||0),0);

      // Title reflects strongest diet flag
      const title =
        f.vegan ? 'Vegan Plan' :
        f.vegetarian ? 'Vegetarian Plan' :
        f.keto ? 'Low-Carb Plan' :
        f.high_protein ? 'High-Protein Plan' : 'Your Plan';

      // Render with spacing (each item is its own block)
      const listHTML = `
        <div class="list-item">
          <div class="item-header">
            <span class="item-title">${title}</span>
            <span class="quantity-badge">Items: ${items.length}</span>
          </div>
          ${items.map(i => `
            <div class="product-block">
              <div class="product-name">${i.name}</div>
              <div class="product-details">
                ${i.note ? `<div>${i.note}</div>`:''}
                <div class="price">$${(i.price||0).toFixed(2)}</div>
              </div>
            </div>
          `).join('')}
          <div class="product-details" style="margin-top:8px;color:#777;">*Prices are rough estimates. Swap items freely.</div>
        </div>`;
      document.getElementById('shoppingList').innerHTML = listHTML;

      const priorities=[];
      if(f.budget) priorities.push('Budget-friendly');
      if(f.health) priorities.push('Health-focused');
      if(f.low_cal) priorities.push('Low-calorie');

      const householdSize=document.getElementById('householdSize').value;
      const duration=document.getElementById('duration').value;

      document.getElementById('summary').innerHTML =
        '<h3 style="margin-bottom:20px;text-align:center;">Shopping Summary</h3>'+
        `<div class="summary-row"><span>Diet Plan:</span><span>${title}</span></div>`+
        `<div class="summary-row"><span>Priorities:</span><span>${priorities.length?priorities.join(', '):'None selected'}</span></div>`+
        `<div class="summary-row"><span>Total Items:</span><span>${items.length}</span></div>`+
        `<div class="summary-row"><span>Household:</span><span>${householdSize} people</span></div>`+
        `<div class="summary-row"><span>Duration:</span><span>${duration} week(s)</span></div>`+
        `<div class="summary-row"><span>Estimated Total:</span><span>$${total.toFixed(2)}</span></div>`;

      // Plain text for copy/email/save
      generatedText = `${title}\n` +
        items.map(i=>`- ${i.name}${i.note?` (${i.note})`:''} ‚Äì $${(i.price||0).toFixed(2)}`).join('\n') +
        `\nEstimated total: $${total.toFixed(2)}` +
        `\n\nHousehold: ${householdSize} people\nDuration: ${duration} week(s)` +
        `\nPriorities: ${priorities.length?priorities.join(', '):'None selected'}`;
    }

    // ------------- Utilities -------------
    function startOver(){
      currentScreen=1; generatedText='';
      document.querySelectorAll('input[type="checkbox"]').forEach(c=>{c.checked=false; const p=c.closest('.checkbox-item'); if(p) p.classList.remove('selected');});
      ['householdSize','duration'].forEach(id=>{}); // keep defaults
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById('screen1').classList.add('active');
      updateSteps(1);
    }

    function copyList(){
      if(!generatedText) return;
      try{
        if(navigator.clipboard?.writeText) navigator.clipboard.writeText(generatedText);
        else { const ta=document.createElement('textarea'); ta.value=generatedText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        alert('List copied to clipboard!');
      }catch(e){ alert('Copy failed. You can still use Print or Save.'); }
    }
function emailList() {
  if (!generatedText) {
    alert('Generate a list first.');
    return;
  }

  // Optional: ask for address
  const to = prompt('Send to which email address? (leave blank to add later)', '');
  const toPart = to && to.trim() ? encodeURIComponent(to.trim()) : '';

  const subject = 'Your Happy Grocer List';
  const body = generatedText + '\n\nGenerated at https://happygrocerco.github.io/happy-grocer/';

  // Gmail web compose link (works even without mail app)
  const gmailURL = `https://mail.google.com/mail/?view=cm&fs=1&to=${toPart}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  // Standard mailto fallback
  const mailto = `mailto:${toPart}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // 1) Try Gmail in a new tab first
  let opened = false;
  try {
    const w = window.open(gmailURL, '_blank');
    opened = !!w;
  } catch (e) {}

  // 2) If popup blocked, try default mail handler
  if (!opened) {
    try { window.location.href = mailto; } catch (e) {}
  }

  // 3) Final fallback: copy text and notify
  setTimeout(() => {
    if (document.visibilityState === 'visible') {
      try { copyList(); } catch (e) {}
      alert("If no email window opened, your list was copied so you can paste it manually.\nTip: in Chrome/Edge, allow Gmail to handle email links.");
    }
  }, 800);
}
    function printList(){
      const html=document.getElementById('resultsScreen').innerHTML;
      const orig=document.body.innerHTML;
      document.body.innerHTML='<style>body{font-family:Arial,sans-serif;padding:20px;color:#333}.btn{display:none}.card{box-shadow:none;border:1px solid #ddd}</style>'+html;
      window.print(); document.body.innerHTML=orig; location.reload();
    }
    function saveList(){
      if(!generatedText) return;
      const blob=new Blob([generatedText],{type:'text/plain'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='happy-grocer-shopping-list.txt';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      alert('Shopping list saved successfully!');
    }

    // ------------- (Optional) Future AI hook -------------
    // IMPORTANT: Do NOT call AI APIs directly from the browser with a secret key.
    // Instead, create a tiny backend endpoint (e.g., on Vercel) at /api/generate,
    // then uncomment and use the code below to POST the user's selections.
    /*
    async function generateWithAI(payload){
      const res = await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data = await res.json(); // expect: { items: [{name,note,price,tags:[]}, ...] }
      return data.items;
    }
    */
  </script>
</body>
</html>





